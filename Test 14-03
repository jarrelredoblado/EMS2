#include <LiquidCrystal_I2C.h>

// LCD Initialization (16x2) with I2C address 0x27
LiquidCrystal_I2C lcd(0x27, 16, 2);

// Define Pins
#define X_PIN A0
#define Y_PIN A1
#define Z_PIN A2
#define BUTTON_PIN 4
#define ST_PIN 5  // Self-Test Pin

// Calibration Data Structure
struct CalibrationData {
    float xPlus, xMinus;
    float yPlus, yMinus;
    float zPlus, zMinus;
} calData;

bool key = false;
long X_calib = 0, Y_calib = 0, Z_calib = 0;
const int numReadings = 50;

void displayLCD(String line1, String line2) {
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print(line1);
    lcd.setCursor(0, 1);
    lcd.print(line2);
}

float readAxisAverage(int pin) {
    long sum = 0;
    for (int i = 0; i < numReadings; i++) {
        sum += analogRead(pin);
        delay(1);
    }
    return (float)sum / numReadings * (5.0 / 1023.0); // Convert to voltage
}

bool selfTestAccelerometer() {
    displayLCD("Self-Test", "Running...");
    delay(1000);

    digitalWrite(ST_PIN, HIGH); // Enable self-test
    delay(100);
    
    float xTest = readAxisAverage(X_PIN);
    float yTest = readAxisAverage(Y_PIN);
    float zTest = readAxisAverage(Z_PIN);
    
    digitalWrite(ST_PIN, LOW); // Disable self-test

    bool testPass = abs(xTest - (-0.325)) < 0.1 &&
                    abs(yTest - (0.325)) < 0.1 &&
                    abs(zTest - (0.550)) < 0.1;

    if (testPass) {
        displayLCD("Self-Test", "Passed");
        delay(2000);
        return true;
    } else {
        displayLCD("Self-Test", "Failed");
        delay(2000);
        return false;
    }
}

void waitForButtonPress() {
    while (digitalRead(BUTTON_PIN) == HIGH);
    delay(300);
    while (digitalRead(BUTTON_PIN) == LOW);
    delay(300);
}

void calibrateAccelerometer() {
    displayLCD("Calibration", "Press Button");
    waitForButtonPress();

    if (!selfTestAccelerometer()) {
        displayLCD("Self-Test", "Check Sensor!");
        return;
    }

    String orientations[6] = {"+X", "-X", "+Y", "-Y", "+Z", "-Z"};
    float readings[6];

    for (int i = 0; i < 6; i++) {
        displayLCD("Position:", orientations[i]);
        waitForButtonPress();
        readings[i] = readAxisAverage(i < 2 ? X_PIN : (i < 4 ? Y_PIN : Z_PIN));
        displayLCD(orientations[i], String(readings[i], 3) + "V");
        waitForButtonPress();
    }

    calData.xPlus = readings[0];
    calData.xMinus = readings[1];
    calData.yPlus = readings[2];
    calData.yMinus = readings[3];
    calData.zPlus = readings[4];
    calData.zMinus = readings[5];

    displayLCD("Calibration", "Complete");
    delay(2000);
}

void displayAccelerometerValues() {
    float x_acc = ((analogRead(X_PIN) - X_calib) * 9.81) / 330.0;
    float y_acc = ((analogRead(Y_PIN) - Y_calib) * 9.81) / 330.0;
    float z_acc = ((analogRead(Z_PIN) - Z_calib) * 9.81) / 330.0;

    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("X:"); lcd.print(x_acc, 2);
    lcd.setCursor(8, 0);
    lcd.print("Y:"); lcd.print(y_acc, 2);
    lcd.setCursor(0, 1);
    lcd.print("Z:"); lcd.print(z_acc, 2);
    delay(100);
}

void calibrate() {
    long X_sum = 0, Y_sum = 0, Z_sum = 0;

    for (int i = 0; i < numReadings; i++) {
        X_sum += analogRead(X_PIN);
        Y_sum += analogRead(Y_PIN);
        Z_sum += analogRead(Z_PIN);
        delay(1);
    }

    X_calib = X_sum / numReadings;
    Y_calib = Y_sum / numReadings;
    Z_calib = Z_sum / numReadings;

    Serial.println("Calibration Done:");
    Serial.print("X: "); Serial.print(X_calib);
    Serial.print(" | Y: "); Serial.print(Y_calib);
    Serial.print(" | Z: "); Serial.println(Z_calib);
}

void setup() {
    Serial.begin(9600);
    lcd.init();
    lcd.backlight();
    pinMode(BUTTON_PIN, INPUT_PULLUP);
    pinMode(ST_PIN, OUTPUT);
    calibrateAccelerometer();
}

void loop() {
    displayAccelerometerValues();
}
